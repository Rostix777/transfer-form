<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Переводы — анкета</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Только CDN-стили/скрипты, без кастомного CSS -->
  <link rel="stylesheet" href="https://rc.tradernet.com/layout/css/tw-like-uikit/desktop.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/2.27.5/js/uikit.min.js"></script>
</head>
<body>

<div class="uk-container uk-container-center uk-margin-large-top uk-margin-large-bottom">

  <h2>Переводы</h2>

  <ul class="uk-tab" data-uk-tab="{connect:'#tabs'}">
    <li><a href="#">Между своими счетами</a></li>
    <li class="uk-active"><a href="#">На банковский счёт</a></li>
    <li><a href="#">Принять перевод</a></li>
  </ul>

  <ul id="tabs" class="uk-switcher uk-margin">
    <li><div class="uk-panel uk-panel-box">Демо-вкладка</div></li>

    <!-- ============================ Анкета на банковский счёт ============================ -->
    <li>
      <form class="uk-form uk-form-stacked" id="transferForm" autocomplete="off">

        <!-- ШАПКА ПОРУЧЕНИЯ -->
        <div class="uk-panel uk-panel-box uk-margin-bottom">

          <!-- Счёт отправителя -->
          <div class="uk-form-row">
            <label class="uk-form-label">Выберите счет отправителя</label>
            <div class="uk-form-controls">
              <select id="senderSelect" class="uk-width-1-1"></select>
            </div>
          </div>

          <!-- Валюта перевода -->
          <div class="uk-form-row">
            <label class="uk-form-label">Валюта перевода</label>
            <div class="uk-form-controls">
              <select id="currencySelect" class="uk-width-1-1"></select>
            </div>
          </div>

          <!-- Сумма / Комиссия -->
          <div class="uk-grid uk-grid-small">
            <div class="uk-width-medium-1-2">
              <div class="uk-form-row uk-margin-top">
                <label class="uk-form-label">Сумма перевода</label>
                <div class="uk-form-controls">
                  <input id="amountInput" class="uk-form-large uk-width-1-1" type="number" step="0.01" placeholder="0.00">
                  <div id="amountHint" class="uk-text-muted uk-margin-small-top"></div>
                </div>
              </div>
            </div>
            <div class="uk-width-medium-1-2">
              <div class="uk-form-row uk-margin-top">
                <label class="uk-form-label">Комиссия, <span id="feeCurrencyLabel">—</span></label>
                <div class="uk-form-controls">
                  <input id="feeInput" class="uk-form-large uk-width-1-1" type="text" placeholder="0.00" disabled>
                  <div id="netBox" class="uk-text-muted uk-margin-small-top"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ТЕЛО ПОРУЧЕНИЯ -->
        <div class="uk-panel uk-panel-box uk-margin-bottom">

          <!-- Выбор получателя -->
          <div class="uk-form-row">
            <label class="uk-form-label">Выберите получателя</label>
            <div class="uk-form-controls">
              <select id="recipientPersonSelect" class="uk-width-1-1">
                <option value="__new__" selected>Добавить нового получателя</option>
                <option value="__own__">На свой счёт в другом банке</option>
                <optgroup label="Сохранённые получатели">
                  <option value="Imirov Ruslan">Imirov Ruslan</option>
                  <option value="Denis Matafonov">Denis Matafonov</option>
                  <option value="Vitaliy Zvonar">Vitaliy Zvonar</option>
                  <option value="Freedom Cheese Ltd.">Freedom Cheese Ltd.</option>
                </optgroup>
              </select>
            </div>
          </div>

          <!-- Выбор счёта получателя -->
          <div class="uk-form-row" id="recipientAccountRow">
            <label class="uk-form-label">Выберите счет получателя</label>
            <div class="uk-form-controls">
              <select id="recipientAccountSelect" class="uk-width-1-1">
                <option value="__new__" selected>Добавить новый счет получателя</option>
              </select>
              <div class="uk-margin-small-top">
                <button id="deleteSavedAccountBtn" type="button" size="small" class="uk-button uk-margin-right uk-button-danger uk-button-small" style="display:none;">Удалить счёт получателя</button>
              </div>
            </div>
          </div>

          <!-- Новое имя получателя (для режима "новый получатель") -->
          <div class="uk-form-row" id="recipientNameRow" style="display:none;">
            <label class="uk-form-label">Введите имя получателя</label>
            <div class="uk-form-controls">
              <input id="recipientNameInput" class="uk-width-1-1" placeholder="Например: Ivan Petrov / Ivan Petrov Ltd.">
            </div>
          </div>

          <!-- Поле IBAN: показывается: новый счёт / сохранённый (readonly) -->
          <div class="uk-form-row" id="ibanRow" style="display:none;">
            <label class="uk-form-label">Номер счета получателя (IBAN)</label>
            <div class="uk-form-controls">
              <input id="ibanInput" class="uk-width-1-1" placeholder="Введите номер счета">
            </div>
          </div>

          <!-- Скрытое хранение IBAN и «имени счёта» -->
          <input id="recipientAccountHidden" type="hidden">
          <input id="accNameHidden" type="hidden">

          <!-- BIC / SWIFT -->
          <div class="uk-form-row">
            <label class="uk-form-label">BIC, SWIFT или Sort code</label>
            <div class="uk-form-controls">
              <input id="bicInput" class="uk-width-1-1" placeholder="XX XXX XX">
              <div id="bankNameHelp" class="uk-text-muted uk-margin-small-top"></div>
            </div>
          </div>
        </div>

        <!-- БАНК-КОРРЕСПОНДЕНТ -->
        <div class="uk-panel uk-panel-box uk-margin-bottom">
          <div class="uk-form-row">
            <label><input type="checkbox" id="toggleCorr"> Указать банк-корреспондент (опционально)</label>
          </div>
          <div id="corrBlock" style="display:none;">
            <div class="uk-form-row uk-margin-top">
              <label class="uk-form-label">Номер счета банка корреспондента</label>
              <div class="uk-form-controls">
                <input id="corrAccInput" class="uk-width-1-1" placeholder="Введите номер счета">
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label">Номер SWIFT/BIC банка корреспондента</label>
              <div class="uk-form-controls">
                <input id="corrBicInput" class="uk-width-1-1" placeholder="XX XXX XX">
                <div id="corrBankNameHelp" class="uk-text-muted uk-margin-small-top"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ПЛАТЁЖНАЯ ИНФОРМАЦИЯ -->
        <div class="uk-panel uk-panel-box uk-margin-bottom" id="paymentInfoBox" style="display:none;">
          <h3 class="uk-panel-title">Платежная информация</h3>

          <div class="uk-form-row">
            <label><input type="checkbox" id="isCompany"> Получатель юридическое лицо</label>
          </div>

          <!-- KZ -->
          <div id="kzBlock" style="display:none;">
            <div class="uk-form-row">
              <label><input type="checkbox" id="isResidentKZ"> Получатель резидент Казахстана</label>
            </div>

          <div class="uk-form-row">
            <label class="uk-form-label">Код бенефициара (Кбе)</label>
            <div class="uk-form-controls">
              <select id="kbeSelect" class="uk-width-1-1"></select>
            </div>
          </div>

            <div class="uk-form-row">
              <label class="uk-form-label">Назначение платежа (КНП)</label>
              <div class="uk-form-controls">
                <select id="knpSelect" class="uk-width-1-1"></select>
              </div>
            </div>
          </div>

          <!-- RU -->
          <div id="ruBlock" style="display:none;">
            <div class="uk-form-row">
              <label><input type="checkbox" id="isResidentRU"> Получатель резидент Российской Федерации</label>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label">Назначение платежа/Код вида операции </label>
              <div class="uk-form-controls">
                <input id="purposeRuInput" class="uk-width-1-1" placeholder="Введите назначение платежа и код операции">
              </div>
            </div>
          </div>   
        </div>

            <!-- АДРЕС -->
            <div class="uk-panel uk-panel-box uk-margin-bottom " id="addressWrap" style="display:none;">
              <div class="uk-form-row">
                <label><input type="checkbox" id="toggleAddress"> Добавить адрес получателя (опционально)</label>
              </div>

              <div id="addressBlock" style="display:none;">

                <!-- Страна -->
                <div class="uk-form-row uk-margin-top">
                  <label class="uk-form-label">Выберите страну получателя</label>
                  <div class="uk-form-controls">
                    <select id="countrySelect" class="uk-width-1-1">
                      <option value="" selected disabled>Выберите страну</option>
                      <!-- ISO-перечень стран (сокращённый до самых употребимых; при желании расширим) -->
                      <option value="AF">Афганистан</option>
                      <option value="AL">Албания</option>
                      <option value="DZ">Алжир</option>
                      <option value="AD">Андорра</option>
                      <option value="AO">Ангола</option>
                      <option value="AG">Антигуа и Барбуда</option>
                      <option value="AR">Аргентина</option>
                      <option value="AM">Армения</option>
                      <option value="AU">Австралия</option>
                      <option value="AT">Австрия</option>
                      <option value="AZ">Азербайджан</option>
                      <option value="BS">Багамы</option>
                      <option value="BH">Бахрейн</option>
                      <option value="BD">Бангладеш</option>
                      <option value="BB">Барбадос</option>
                      <option value="BY">Беларусь</option>
                      <option value="BE">Бельгия</option>
                      <option value="BZ">Белиз</option>
                      <option value="BJ">Бенин</option>
                      <option value="BO">Боливия</option>
                      <option value="BA">Босния и Герцеговина</option>
                      <option value="BW">Ботсвана</option>
                      <option value="BR">Бразилия</option>
                      <option value="BN">Бруней</option>
                      <option value="BG">Болгария</option>
                      <option value="BF">Буркина-Фасо</option>
                      <option value="BI">Бурунди</option>
                      <option value="KH">Камбоджа</option>
                      <option value="CM">Камерун</option>
                      <option value="CA">Канада</option>
                      <option value="CV">Кабо-Верде</option>
                      <option value="CF">ЦАР</option>
                      <option value="TD">Чад</option>
                      <option value="CL">Чили</option>
                      <option value="CN">Китай</option>
                      <option value="CO">Колумбия</option>
                      <option value="KM">Коморы</option>
                      <option value="CG">Конго</option>
                      <option value="CD">ДР Конго</option>
                      <option value="CR">Коста-Рика</option>
                      <option value="CI">Кот-д’Ивуар</option>
                      <option value="HR">Хорватия</option>
                      <option value="CU">Куба</option>
                      <option value="CY">Кипр</option>
                      <option value="CZ">Чехия</option>
                      <option value="DK">Дания</option>
                      <option value="DJ">Джибути</option>
                      <option value="DM">Доминика</option>
                      <option value="DO">Доминиканская Республика</option>
                      <option value="EC">Эквадор</option>
                      <option value="EG">Египет</option>
                      <option value="SV">Сальвадор</option>
                      <option value="GQ">Экваториальная Гвинея</option>
                      <option value="ER">Эритрея</option>
                      <option value="EE">Эстония</option>
                      <option value="ET">Эфиопия</option>
                      <option value="FJ">Фиджи</option>
                      <option value="FI">Финляндия</option>
                      <option value="FR">Франция</option>
                      <option value="GA">Габон</option>
                      <option value="GM">Гамбия</option>
                      <option value="GE">Грузия</option>
                      <option value="DE">Германия</option>
                      <option value="GH">Гана</option>
                      <option value="GR">Греция</option>
                      <option value="GD">Гренада</option>
                      <option value="GT">Гватемала</option>
                      <option value="GN">Гвинея</option>
                      <option value="GW">Гвинея-Бисау</option>
                      <option value="GY">Гайана</option>
                      <option value="HT">Гаити</option>
                      <option value="HN">Гондурас</option>
                      <option value="HK">Гонконг</option>
                      <option value="HU">Венгрия</option>
                      <option value="IS">Исландия</option>
                      <option value="IN">Индия</option>
                      <option value="ID">Индонезия</option>
                      <option value="IR">Иран</option>
                      <option value="IQ">Ирак</option>
                      <option value="IE">Ирландия</option>
                      <option value="IL">Израиль</option>
                      <option value="IT">Италия</option>
                      <option value="JM">Ямайка</option>
                      <option value="JP">Япония</option>
                      <option value="JO">Иордания</option>
                      <option value="KZ">Казахстан</option>
                      <option value="KE">Кения</option>
                      <option value="KR">Корея, Республика</option>
                      <option value="KW">Кувейт</option>
                      <option value="KG">Киргизия</option>
                      <option value="LA">Лаос</option>
                      <option value="LV">Латвия</option>
                      <option value="LB">Ливан</option>
                      <option value="LS">Лесото</option>
                      <option value="LR">Либерия</option>
                      <option value="LY">Ливия</option>
                      <option value="LI">Лихтенштейн</option>
                      <option value="LT">Литва</option>
                      <option value="LU">Люксембург</option>
                      <option value="MO">Макао</option>
                      <option value="MG">Мадагаскар</option>
                      <option value="MW">Малави</option>
                      <option value="MY">Малайзия</option>
                      <option value="MV">Мальдивы</option>
                      <option value="ML">Мали</option>
                      <option value="MT">Мальта</option>
                      <option value="MX">Мексика</option>
                      <option value="MD">Молдова</option>
                      <option value="MC">Монако</option>
                      <option value="MN">Монголия</option>
                      <option value="ME">Черногория</option>
                      <option value="MA">Марокко</option>
                      <option value="MZ">Мозамбик</option>
                      <option value="MM">Мьянма</option>
                      <option value="NA">Намибия</option>
                      <option value="NP">Непал</option>
                      <option value="NL">Нидерланды</option>
                      <option value="NZ">Новая Зеландия</option>
                      <option value="NI">Никарагуа</option>
                      <option value="NE">Нигер</option>
                      <option value="NG">Нигерия</option>
                      <option value="MK">Северная Македония</option>
                      <option value="NO">Норвегия</option>
                      <option value="OM">Оман</option>
                      <option value="PK">Пакистан</option>
                      <option value="PS">Палестина</option>
                      <option value="PA">Панама</option>
                      <option value="PG">Папуа — Новая Гвинея</option>
                      <option value="PY">Парагвай</option>
                      <option value="PE">Перу</option>
                      <option value="PH">Филиппины</option>
                      <option value="PL">Польша</option>
                      <option value="PT">Португалия</option>
                      <option value="QA">Катар</option>
                      <option value="RO">Румыния</option>
                      <option value="RU">Россия</option>
                      <option value="RW">Руанда</option>
                      <option value="SA">Саудовская Аравия</option>
                      <option value="SN">Сенегал</option>
                      <option value="RS">Сербия</option>
                      <option value="SC">Сейшелы</option>
                      <option value="SL">Сьерра-Леоне</option>
                      <option value="SG">Сингапур</option>
                      <option value="SK">Словакия</option>
                      <option value="SI">Словения</option>
                      <option value="ZA">ЮАР</option>
                      <option value="ES">Испания</option>
                      <option value="LK">Шри-Ланка</option>
                      <option value="SE">Швеция</option>
                      <option value="CH">Швейцария</option>
                      <option value="SY">Сирия</option>
                      <option value="TW">Тайвань</option>
                      <option value="TJ">Таджикистан</option>
                      <option value="TZ">Танзания</option>
                      <option value="TH">Таиланд</option>
                      <option value="TL">Тимор-Лесте</option>
                      <option value="TG">Того</option>
                      <option value="TT">Тринидад и Тобаго</option>
                      <option value="TN">Тунис</option>
                      <option value="TR">Турция</option>
                      <option value="TM">Туркменистан</option>
                      <option value="UG">Уганда</option>
                      <option value="UA">Украина</option>
                      <option value="AE">ОАЭ</option>
                      <option value="GB">Великобритания</option>
                      <option value="US">США</option>
                      <option value="UY">Уругвай</option>
                      <option value="UZ">Узбекистан</option>
                      <option value="VE">Венесуэла</option>
                      <option value="VN">Вьетнам</option>
                      <option value="YE">Йемен</option>
                      <option value="ZM">Замбия</option>
                      <option value="ZW">Зимбабве</option>
                    </select>
                  </div>
                </div>

                <!-- Город -->
                <div class="uk-form-row">
                  <label class="uk-form-label">Город получателя</label>
                  <div class="uk-form-controls">
                    <input id="cityInput" class="uk-width-1-1" placeholder="Например: Алматы / Москва / Никосия">
                  </div>
                </div>

                <!-- Адрес -->
                <div class="uk-form-row">
                  <label class="uk-form-label">Адрес получателя</label>
                  <div class="uk-form-controls">
                    <input id="addressLineInput" class="uk-width-1-1" placeholder="Улица, дом, корпус/строение, квартира/офис">
                  </div>
                </div>

              </div>
            </div>


          <!-- ДОКУМЕНТ -->
          <div class="uk-panel uk-panel-box uk-margin-bottom" id="docWrap">
            <div class="uk-form-row">
              <label class="uk-form-label uk-margin-right">Добавить документ (опционально)</label>
              <div class="uk-form-file">
                <button class="uk-button"><i class="uk-icon-folder-open"></i> Выберите файл</button>
                <input id="docFile" type="file">
              </div>
            </div>
          </div>


                <!-- Итог -->
                <div class="uk-panel uk-panel-box">
                  <div class="uk-margin-top">
                    <button type="button" id="submitBtn" class="uk-button uk-button-large uk-button-success uk-width-1-1">Перевести</button>
                  </div>
                  <div id="submitResult" class="uk-text-small uk-text-muted uk-margin-small-top"></div>
                </div>

              </form>
            </li>

            <li><div class="uk-panel uk-panel-box">Демо-вкладка</div></li>
          </ul>
        </div>

<script>
(function($){
  /* ===== Демо-данные ===== */
  var ACCOUNTS = [
    {no:"1468877", title:"1468877 (1435.86 USD) - Freedom Broker", resident:"NL", balances:{USD:1435.86, EUR:960.23, GBP:0, CHF:0, KZT:0}},
    {no:"1577681", title:"1577681 (923.95 EUR) - Freedom24",      resident:"NL", balances:{USD:402.46,  EUR:923.95, GBP:0, CHF:0, KZT:0}}
  ];
  var SAVED = {
    "__own__": {
      "KZ10551B629821335KZT": {iban:"KZ10551B629821335KZT", bic:"KSNVKZKA", bank:"FREEDOM BANK KAZAKHSTAN", country:"KZ", isCompany:false, residentKZ:true},
      "78817840600000191234": {iban:"78817840600000191234", bic:"044525900", bank:"CIFRA BANK", country:"RU", isCompany:false, residentRU:false},
      "CY10551TS23827728EUR": {iban:"CY10551TS23827728EUR", bic:"PIRBCY2NXXX", bank:"ASTRO BANK", country:"CY", isCompany:false}
    },
    "Imirov Ruslan": {
      "KZ12561B629821335KZT": {iban:"KZ12561B629821335KZT", bic:"KSNVKZKA", bank:"FREEDOM BANK KAZAKHSTAN", country:"KZ", isCompany:false, residentKZ:true, personName:"Imirov Ruslan"},
      "KZ97741S235821323USD": {iban:"KZ97741S235821323USD", bic:"KSPIKZKA", bank:"KASPI BANK", country:"KZ", isCompany:false, residentKZ:true, personName:"Imirov Ruslan"}
    },
    "Denis Matafonov": {
      "40817840600000196164": {iban:"40817840600000196164", bic:"044525900", bank:"CIFRA BANK", country:"RU", isCompany:false, residentRU:true, personName:"Denis Matafonov"},
      "78617850600000197129": {iban:"78617850600000197129", bic:"044525225", bank:"SBER BANK",  country:"RU", isCompany:false, residentRU:true, personName:"Denis Matafonov"}
    },
    "Vitaliy Zvonar": {
      "CY10551TS23827728EUR": {iban:"CY10551TS23827728EUR", bic:"PIRBCY2NXXX", bank:"ASTRO BANK", country:"CY", isCompany:false}
    },
    "Freedom Cheese Ltd.": {
      "CY94008002030000000003019786": {iban:"CY94008002030000000003019786", bic:"PIRBCY2NXXX", bank:"ASTRO BANK",    country:"CY", isCompany:true,
        corr:{acc:"US94 0080 0203 0000 0000 0301 9786", bic:"ASDKG1235", bank:"MORGAN STANLEY CHEESE Ltd."}},
      "CY57008005550000000007566987": {iban:"CY57008005550000000007566987", bic:"HEBACY2NXXX", bank:"HELLENIC BANK", country:"CY", isCompany:true}
    }
  };

  var KBE_SECTORS = [
    ["1","Центральное Правительство"],["2","Региональные и местные органы управления"],
    ["3","Центральные (национальные) банки"],["4","Другие депозитные организации"],
    ["5","Другие финансовые организации"],["6","Гос. нефинансовые организации"],
    ["7","Негос. нефинансовые организации"],["8","НКО (дом. хозяйства)"],["9","Домашние хозяйства"]
  ];
  var KNP_ALL = [
    ["010","Обязательные пенсионные взносы"],["012","Социальные отчисления"],["013","Добровольные пенсионные взносы"],
    ["015","Обязательные профессиональные пенсионные взносы"],["017","Пеня за несвоевременные соц. отчисления"],
    ["019","Пеня за несвоевременные ОПВ"],["118","Алименты"],["119","Неустойка по договорам"],["120","Членские взносы"],
    ["121","ОСМС отчисления"],["122","ОСМС взносы"],["123","Пеня ОСМС-отчисления"],["124","Пеня ОСМС-взносы"],
    ["171","Гарантийный взнос"],["183","ЕСП"],["331","Взнос наличных"],["332","Зарплаты/отпускные"],
    ["341","Снятие наличных"],["342","Перевод между своими (в банке)"],["343","Перевод между своими (другой банк)"],
    ["421","Погашение краткосрочных займов"],["423","Погашение долгосрочных займов"],["424","Финансовый лизинг"],
    ["429","Прочие займы"],["610","Акции/уставный капитал"],["661","Дивиденды"],["710","Платежи за товары"],
    ["720","Платежи за недвижимость"],["730","Непроизведенные активы"],["780","Возврат за товары/НМА"],
    ["810","Транспорт/склады"],["811","Воздушный транспорт"],["812","Водный транспорт"],["813","Ж/д транспорт"],
    ["814","Иной сухопутный транспорт"],["815","Трубопроводы"],["816","Хранение и складирование"],["818","Почта/курьеры"],
    ["821","Строительные услуги"],["822","Ремонт/ТО"],["831","Страхование жизни"],["851","Компьютерные услуги"],
    ["852","Связь"],["853","Использование ИС"],["854","Юридические услуги"],["855","Лизинг (аренда)"],
    ["858","Реклама/исследования"],["859","Проф./науч./техн. услуги"],["860","Услуги частным лицам, культура/отдых"],
    ["861","Образование"],["862","Медицина"],["871","Поездки"],["872","Проживание и питание"],["880","Возврат за услуги"],
    ["911","Обязательства в бюджет"],["912","Пеня в бюджет"],["913","Штрафы РК"],["917","Поступления при изменении сроков"],
    ["918","Пеня при изменении сроков"],["925","Проценты за отсрочку ввозных пошлин"]
  ];
  var KNP_FREQUENT = [["013","Добровольные пенсионные взносы"],["343","Перевод на свой счёт в другом банке"],["710","Платежи за товары"]];

  /* ===== Утилиты ===== */
  function fmt(n){return (n||0).toFixed(2);}
  function renderOptions($s, list, selected){
    $s.empty();
    list.forEach(function(row){
      var v=row[0], t=row[1];
      var $o=$("<option>").val(v).text(v+(t && t!=="—" ? " — "+t : ""));
      if(v===selected) $o.attr("selected","selected");
      $s.append($o);
    });
  }
  function toggleIbanRow(show, readonly){
    if(show){
      $("#ibanRow").show();
      if(readonly){ $("#ibanInput").prop("disabled", true); }
      else { $("#ibanInput").prop("disabled", false).val("").focus(); }
    } else {
      $("#ibanRow").hide(); $("#ibanInput").prop("disabled", false).val("");
    }
  }
  function showDeleteButton(show){
    $("#deleteSavedAccountBtn").toggle(!!show);
  }
function getAccountBaseCurrency(acc){
  // Пытаемся вытащить валюту из заголовка: "1468877 (1435.86 USD) - Freedom Broker" -> USD
  var m = (acc.title || "").match(/\(([^)]+)\)/);
  if (m && m[1]) {
    var parts = m[1].trim().split(/\s+/);
    return (parts[parts.length - 1] || "").toUpperCase();
  }
  // Фолбэк: берём валюту с максимальным остатком
  var best = "USD", bestVal = -1;
  Object.keys(acc.balances || {}).forEach(function(c){
    var v = acc.balances[c] || 0;
    if (v > bestVal) { best = c; bestVal = v; }
  });
  return best.toUpperCase();
}
function hidePaymentCheckboxesForSaved(){
  // скрываем строки с чекбоксами "юр. лицо" и "резидент KZ"
  $("#isCompany").closest(".uk-form-row").hide();
  $("#isResidentKZ").closest(".uk-form-row").hide();
}

function showPaymentCheckboxes(){
  // показываем обратно (используется для новых счетов/ввода IBAN)
  $("#isCompany").closest(".uk-form-row").show();
  $("#isResidentKZ").closest(".uk-form-row").show();
}

  /* ====== Шапка ====== */
  function initHeader(){
    var $sender=$("#senderSelect").empty();
    ACCOUNTS.forEach(function(a){ $sender.append($("<option>").val(a.no).text(a.title)); });
    updateCurrencyOptions(ACCOUNTS[0]);
    updateHeaderHints();
  }
  function getSender(){
    var no=$("#senderSelect").val();
    return ACCOUNTS.find(function(a){return a.no===no;})||ACCOUNTS[0];
  }
  function updateCurrencyOptions(acc){
    var $c=$("#currencySelect").empty();
    ["USD","EUR","GBP","CHF","KZT"].forEach(function(cur){
      var bal=acc.balances[cur]||0;
      $c.append($("<option>").val(cur).text(cur+" (остаток "+fmt(bal)+")"));
    });
    $("#feeCurrencyLabel").text($("#currencySelect").val());
  }
  function updateHeaderHints(){
    var acc=getSender();
    var cur=$("#currencySelect").val();
    var bal=acc.balances[cur]||0;
    var available=bal*0.9;
    $("#amountHint").text("Доступно с учётом маржи "+fmt(available));

    // базовая валюта счёта для комиссии
    var baseCur = getAccountBaseCurrency(acc);
    $("#feeCurrencyLabel").text(baseCur);

    var amt=parseFloat($("#amountInput").val()||"0");
    var fee=amt*0.03; // демо-тариф 3%
    $("#feeInput").val(fmt(fee)+" "+baseCur);

    // Нетто по-прежнему показываем в валюте перевода
    $("#netBox").text("Сумма к зачислению за вычетом комиссии: " + fmt(Math.max(amt - fee, 0)) + " " + baseCur);
  }

  /* ====== Блок получателя ====== */
  function resetForNewAccount(){
    $("#recipientAccountHidden").val("");
    $("#accNameHidden").val("");
    $("#bicInput").val("").prop("disabled", false);
    $("#bankNameHelp").text("");
    $("#toggleCorr").prop("checked", false); $("#corrBlock").hide();
    $("#corrAccInput, #corrBicInput").val(""); $("#corrBankNameHelp").text(""); $("#corrBicInput").prop("disabled", false);
    $("#paymentInfoBox").hide(); $("#kzBlock, #ruBlock").hide();
    $("#addressWrap, #docWrap").show();
    $("#toggleAddress, #toggleDoc").prop("checked", false); $("#addressBlock, #docBlock").hide();
  }
  function fillSavedAccount(person, key){
    var info=(SAVED[person]||{})[key]; if(!info) return;
    // IBAN: показываем и блокируем (по пожеланию)
    toggleIbanRow(true, /*readonly*/true);
    $("#ibanInput").val(info.iban);
    $("#recipientAccountHidden").val(info.iban);
    $("#accNameHidden").val(info.personName || person);
    // BIC: автозаполнение и блокировка
    $("#bicInput").val(info.bic||"").prop("disabled", !!info.bic);
    $("#bankNameHelp").text(info.bank || "");
    // корреспондент
    if(info.corr){
      $("#toggleCorr").prop("checked", true);
      $("#corrBlock").show();
      $("#corrAccInput").val(info.corr.acc);
      $("#corrBicInput").val(info.corr.bic).prop("disabled", true);
      $("#corrBankNameHelp").text(info.corr.bank||"");
    }else{
      $("#toggleCorr").prop("checked", false);
      $("#corrBlock").hide();
      $("#corrAccInput, #corrBicInput").val(""); $("#corrBankNameHelp").text(""); $("#corrBicInput").prop("disabled", false);
    }
    showPaymentInfoByJurisdiction(info);
        // Скрываем чекбоксы при выборе сохранённого счёта (в т.ч. "__own__")
    hidePaymentCheckboxesForSaved();
    $("#addressWrap, #docWrap").hide();
    showDeleteButton(person!=="__own__");
    $("#addressWrap, #docWrap").hide();
    showDeleteButton(person!=="__own__"); // показывать, если сохранённый, кроме «между своими»
  }
  function showPaymentInfoByJurisdiction(info){
    var cc=info.country;
    if(cc==="KZ"){
      $("#paymentInfoBox").show(); $("#kzBlock").show(); $("#ruBlock").hide();
      $("#isResidentKZ").prop("checked", info.residentKZ!==undefined ? !!info.residentKZ : true);
      $("#isCompany").prop("checked", !!info.isCompany);
      recomputeKBE(); defaultKNP();
    }else if(cc==="RU"){
      $("#paymentInfoBox").show(); $("#kzBlock").hide(); $("#ruBlock").show();
      $("#isResidentRU").prop("checked", info.residentRU!==undefined ? !!info.residentRU : true);
      $("#isCompany").prop("checked", !!info.isCompany);
    }else{
      $("#paymentInfoBox").hide();
    }
  }

  /* ====== Автоопределение по IBAN (префикс-детект для демо) ====== */
  function autoDetectByIbanPrefix(ibanRaw){
    var raw=(ibanRaw||"").toUpperCase().replace(/\s+/g,"");
    if(!raw) return null;
    if(/^KZ/.test(raw)){
      return {iban:raw,bic:"",bank:"",country:"KZ",isCompany:false,residentKZ:true};
    }
    if(/^\d{2}/.test(raw)){
      return {iban:raw,bic:"",bank:"",country:"RU",isCompany:false,residentRU:true};
    }
    if(/^[A-Z]{2}/.test(raw)){
      return {iban:raw,bic:"",bank:"",country:"OTHER",isCompany:false};
    }
    return null;
  }

  /* ====== KZ: КБЕ/КНП ====== */
  function recomputeKBE(){
    if(!$("#kzBlock").is(":visible")) return;
    var isResident = $("#isResidentKZ").is(":checked");
    var isCompany  = $("#isCompany").is(":checked");
    var first = isResident ? "1" : "2";
    var second= isCompany ? "5" : "9";
    var list = KBE_SECTORS.map(function(s){ return [first + s[0], s[1]]; });
    renderOptions($("#kbeSelect"), list, first+second);
  }
  function defaultKNP(){
    if(!$("#kzBlock").is(":visible")) return;
    var isCompany=$("#isCompany").is(":checked");
    var selected = isCompany ? "710" : "429";
    var list = KNP_FREQUENT.concat([["—","—"]]).concat(KNP_ALL);
    renderOptions($("#knpSelect"), list, selected);
  }

  /* ====== Валидации (минимальные) ====== */
  function validate(){
    var acc=getSender();
    var cur=$("#currencySelect").val();
    var bal=acc.balances[cur]||0;
    var available=bal*0.9;
    var amt=parseFloat($("#amountInput").val()||"0");
    if(!(amt>0)) return "Введите сумму перевода";
    if(amt>available) return "Сумма превышает доступную с учётом маржи";
    if($("#recipientAccountSelect").val()==="__new__"){
      if(!($("#ibanInput").val()||"").trim()) return "Введите номер счета получателя (IBAN)";
    }
    if($("#kzBlock").is(":visible")){
      if(!$("#kbeSelect").val()) return "Выберите КБЕ";
      if(!$("#knpSelect").val()) return "Выберите КНП";
    }
    if($("#ruBlock").is(":visible")){
      if(!$("#kbkInput").val()) return "Укажите КБК";
      if(!$("#purposeRuInput").val()) return "Укажите назначение платежа (РФ)";
    }
    return null;
  }

  /* ====== Слушатели ====== */
  $("#senderSelect").on("change", function(){ updateCurrencyOptions(getSender()); updateHeaderHints(); });
  $("#currencySelect, #amountInput").on("input change", updateHeaderHints);

  // Выбор получателя
  $("#recipientPersonSelect").on("change", function(){
    var person=$(this).val();

    // режим "новый получатель": скрыть селектор счетов, показать «Введите имя» и IBAN (редактируемый)
    if(person==="__new__"){
      $("#recipientAccountRow").hide();
      $("#recipientNameRow").show();
      resetForNewAccount();
      toggleIbanRow(true, /*readonly*/false);
      showDeleteButton(false);
      showPaymentCheckboxes();
      return;
    } else {
      $("#recipientNameRow").hide();
      $("#recipientAccountRow").show();
    }

    var $acc=$("#recipientAccountSelect").empty();
    $acc.append($("<option>").val("__new__").text("Добавить новый счет получателя"));
    showDeleteButton(false);

    var map=(SAVED[person]||{});
    if(person==="__own__") map=SAVED["__own__"]||{};
    var keys=Object.keys(map);

    if(keys.length){
      var label = (person==="__own__") ? "Между своими счетами (все личные сохраненные счета)" : person;
      var $og=$("<optgroup>").attr("label", label);
      keys.forEach(function(k){
        var info=map[k]||{};
        var text = (info.iban||k) + (info.bank ? (", "+info.bank) : "");
        $og.append($("<option>").val(person+"|"+k).text(text));
      });
      $acc.append($og);
      // По умолчанию выбрать первый сохранённый счёт
      $acc.val(person+"|"+keys[0]).trigger("change");
    }else{
      $acc.val("__new__");
      resetForNewAccount();
      toggleIbanRow(true, false);
    }
  });

  // Выбор счёта получателя
  $("#recipientAccountSelect").on("change", function(){
    var val=$(this).val();
    if(val==="__new__"){
      resetForNewAccount();
      toggleIbanRow(true, /*readonly*/false);
      showDeleteButton(false);
      // >>> добавь:
      showPaymentCheckboxes();
      return;
    }
    var parts=val.split("|"), person=parts[0], key=parts[1];
    fillSavedAccount(person, key);
  });

  // IBAN ввод — префикс-детект (KZ | 2 цифры | другие буквы)
  $("#ibanInput").on("input", function(){
    var raw=($(this).val()||"").toUpperCase().replace(/\s+/g,"");
    if(!raw){ $("#paymentInfoBox").hide(); $("#kzBlock, #ruBlock").hide(); return; }
    if(/^KZ/.test(raw)){
      $("#ibanHint").text("Обнаружен KZ — показываем блок параметров для Казахстана");
      $("#paymentInfoBox").show(); $("#kzBlock").show(); $("#ruBlock").hide();
      $("#isResidentKZ").prop("checked", true); $("#isCompany").prop("checked", false);
      // >>> на всякий случай показываем чекбоксы (для режима нового счёта)
      showPaymentCheckboxes();
      recomputeKBE(); defaultKNP();
      if ($("#recipientPersonSelect").val() === "__new__") $("#knpSelect").val("343");
    }else if(/^\d{2}/.test(raw)){
      $("#ibanHint").text("Обнаружен префикс 2 цифры — идентифицирован как РФ");
      $("#paymentInfoBox").show(); $("#kzBlock").hide(); $("#ruBlock").show();
      $("#isResidentRU").prop("checked", true); $("#isCompany").prop("checked", false);
    }else if(/^[A-Z]{2}/.test(raw)){
      $("#ibanHint").text("Иная юрисдикция — дополнительные параметры не требуются");
      $("#paymentInfoBox").hide(); $("#kzBlock, #ruBlock").hide();
    }else{
      $("#ibanHint").text("Проверьте формат номера счёта");
      $("#paymentInfoBox").hide(); $("#kzBlock, #ruBlock").hide();
    }
  }).on("blur change", function(){
    $("#recipientAccountHidden").val($(this).val().toUpperCase().replace(/\s+/g,""));
  });

  // Переключатели
  $("#toggleCorr").on("change", function(){ $("#corrBlock").toggle(this.checked); });
  $("#toggleAddress").on("change", function(){ $("#addressBlock").toggle(this.checked); });
  $("#toggleDoc").on("change", function(){ $("#docBlock").toggle(this.checked); });
  $("#isCompany").on("change", function(){ if($("#kzBlock").is(":visible")) {recomputeKBE(); defaultKNP();} });
  $("#isResidentKZ").on("change", recomputeKBE);

  // Удаление сохранённого счёта (кроме «между своими»)
  $("#deleteSavedAccountBtn").on("click", function(){
    var v=$("#recipientAccountSelect").val();
    if(!v || v==="__new__") return;
    var parts=v.split("|"), person=parts[0], key=parts[1];
    if(person==="__own__") return;
    if(SAVED[person] && SAVED[person][key]){
      delete SAVED[person][key];
      $("#recipientPersonSelect").trigger("change");
      $("#submitResult").text("Счёт получателя удалён (демо).");
    }
  });

  // Отправка
  $("#submitBtn").on("click", function(){
    var err=validate();
    if(err){ $("#submitResult").text(err); return; }
    $("#submitResult").text("Готово. Поручение сформировано (демо).");
  });

  /* ====== Инициализация ====== */
  (function init(){
    // счёт/валюта/комиссия
    var $sender=$("#senderSelect").empty();
    ACCOUNTS.forEach(function(a){ $sender.append($("<option>").val(a.no).text(a.title)); });
    updateCurrencyOptions(ACCOUNTS[0]); updateHeaderHints();
    // режим: новый получатель (прячем селектор счетов, показываем имя + IBAN)
    $("#recipientPersonSelect").val("__new__").trigger("change");
  })();

})(jQuery);
</script>

</body>
</html>




